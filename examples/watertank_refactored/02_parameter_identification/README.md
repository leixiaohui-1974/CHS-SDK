# 示例 2: 水箱出口系数参数辨识 (重构版)

## 1. 场景目标

本示例演示了一个经典的参数辨识场景。我们假设有一个物理世界中的“真实”水库，其部分物理参数（如此处的**出口系数 `outlet_coeff`**）是未知的。

我们的目标是创建一个该水库的“数字孪生”模型，并让这个孪生模型通过在线学习，持续观测真实水库的输入（入流量）和输出（水位），动态调整自身的出口系数值，使其最终收敛到真实水库的系数值。

这个过程对于修正模型误差、提高数字孪生仿真精度至关重要。

## 2. 架构设计 (重构说明)

本示例是 对 `examples/watertank/02_parameter_identification` 中原有脚本式实现的**场景驱动式重构**。重构的核心思想是将原Python脚本中的仿真循环和硬编码的智能体连接，转换为由配置文件驱动的、基于消息总线的标准架构。

### 关键智能体

-   `CsvInflowAgent`: 从 `inflow.csv` 文件中读取预设的入流数据，并将其发布到消息总线的 `inflow_topic` 主题上。
-   `BusAwareReservoirAgent`: (定义于本目录的 `agents.py` 中) 扮演“**真实水库**”的角色。它订阅 `inflow_topic` 获取入流量，使用一个**固定不变的真实出口系数 (0.8)** 进行仿真，并将其产生的水位发布到 `real_water_level_topic` 主题。
-   `BusAwareTwinAgent`: (定义于本目录的 `agents.py` 中) 扮演“**数字孪生水库**”的角色。
    -   它同样订阅 `inflow_topic` 以保证输入与真实水库一致。
    -   它还订阅 `real_water_level_topic` 来“观测”真实水库的水位。
    -   在每个时间步，它使用自己当前的出口系数（**初始猜测值为 0.2**）进行仿真，然后将仿真水位与观测到的真实水位进行比较。
    -   根据两者之间的误差，它采用简单的梯度下降法来更新自己的出口系数值。
    -   最后，它将自己估算出的系数发布到 `estimated_coeff_log_topic` 主题，以便我们观察辨识过程。

## 3. 如何运行

在项目根目录下执行以下命令：

```bash
python run_scenario.py examples/watertank_refactored/02_parameter_identification
```

## 4. 预期结果

仿真运行结束后，会在本目录下生成一个 `output.yml` 文件，其中记录了消息总线上所有主题在每个时间步的数据。

您可以重点关注以下几个主题的记录：

-   `real_water_level_topic`: “真实”水库的水位变化。
-   `twin_water_level_log_topic`: “孪生”水库的水位变化。随着辨识的进行，它会越来越接近真实水位。
-   `estimated_coeff_log_topic`: **辨识出的出口系数值**。您可以观察到，它的值会从初始的 `0.2` 逐步增加，并最终在真实值 `0.8` 附近稳定下来，证明参数辨识取得了成功。
