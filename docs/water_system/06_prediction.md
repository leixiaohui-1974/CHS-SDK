# 6. 预测 (Prediction)

本篇文档详细介绍 `core_lib` 中预测功能的设计与实现。

## 1. 核心理念：分层式的预测架构

`core_lib` 中的预测功能采用了一种**分层式**的设计，以满足不同层次的需求：

1.  **本地趋势预测 (Local Trend Prediction)**: 由简单的本地智能体执行，用于快速检测单个数据流的短期变化趋势。
2.  **中心化需量预测 (Centralized Demand Forecasting)**: 由一个中心化的智能体负责，旨在结合多种数据源，生成系统级的、更长期的需水量预测，为优化调度提供关键输入。

## 2. 关键组件

### 2.1 预测算法库

*   **位置**: `core_lib/local_agents/prediction/`
*   **职责**: 该目录提供了一系列可重用的预测算法模型，例如：
    *   `arima_forecaster.py`: 实现了经典的 ARIMA (自回归积分移动平均)模型，适用于单变量时间序列预测。
    *   `lstm_forecaster.py`: 提供了一个基于 LSTM (长短期记忆)神经网络的深度学习模型，能够处理更复杂的多变量、非线性预测问题。
*   **说明**: 这些模块封装了预测的核心数学逻辑，但它们本身不是智能体，需要被智能体调用。

### 2.2 `ForecastingAgent` (本地趋势预测)

*   **位置**: `core_lib/local_agents/prediction/forecasting_agent.py`
*   **职责**: 一个简单的智能体，用于监控**单一**数据主题。
*   **工作流程**:
    1.  监听一个数据主题（如某个节点的压力）。
    2.  维护一个固定大小的滑动窗口 (`window_size`) 来存储最近的数据点。
    3.  在每个时间步，通过比较窗口内最早和最新的数据，判断出"increasing"、"decreasing" 或 "stable" 的简单趋势。
    4.  当趋势发生变化时，将新趋势发布到消息总线。
*   **用途**: 主要用于本地化的、需要快速响应的简单逻辑，或者作为更复杂预测模型的预警信号。

### 2.3 `DemandForecastingAgent` (中心化需量预测)

*   **位置**: `core_lib/central_coordination/dispatch/demand_forecasting_agent.py`
*   **职责**: 作为系统级的需水量预测服务。
*   **工作流程 (设计意图)**:
    1.  **订阅**: 订阅多个历史数据主题（如不同区域的总用水量、关键点的水位等）。
    2.  **汇集**: 持续收集这些数据。
    3.  **触发**: 周期性地（例如，代码中占位符为每24小时）触发一次预测生成过程。
    4.  **调用模型**: 在 `generate_forecast()` 方法中，它应该使用汇集的历史数据，并调用一个或多个在算法库中定义的预测模型（如 `lstm_forecaster`）来计算未来的需水量。
    5.  **发布预测**: 将包含未来24小时（或更长）需水量的时间序列预测结果，发布到一个指定的 `forecast_topic`。下游的调度智能体 (`CentralDispatcherAgent`) 会订阅此主题。

### 4. 实现说明

与诊断模块类似，`DemandForecastingAgent` 的核心功能目前也是一个**占位符**。它已经实现了数据订阅和周期性触发的框架，但 `generate_forecast()` 方法中调用具体预测模型的步骤尚未实现。当前的实现只是发布一个固定的、用于演示的预测结果。
