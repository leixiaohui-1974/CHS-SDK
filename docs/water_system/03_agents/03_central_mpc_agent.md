# 核心智能体: 模型预测控制代理 (CentralMPCAgent)

*   **源代码**: `core_lib/central_coordination/dispatch/central_mpc_agent.py`
*   **类型**: 中心化调度代理 (Central Dispatch Agent)

## 1. 概述

`CentralMPCAgent` 是 `core_lib` 中提供的最先进的调度智能体。它使用**模型预测控制 (Model Predictive Control, MPC)** 这一高级控制策略，来实现对系统的**前瞻性、最优化**调度。

与基于固定规则的 `CentralDispatcher` 不同，MPC能够在每个决策时刻，动态地求解一个面向未来的优化问题，从而找到当前最优的控制决策。

## 2. 模型预测控制 (MPC) 工作原理

MPC的核心思想是“滚动优化”和“有限时域”。在每个控制周期（即每个`run()`调用），`CentralMPCAgent` 都会执行以下完整流程：

1.  **获取当前状态**: 从消息总线获取系统最新的状态（如各个水库的当前水位）。
2.  **获取未来扰动**: 从消息总线获取对未来一段时间（称为**预测时域 (Prediction Horizon)**, `H_p`）的扰动预测（如未来24小时的入库流量）。
3.  **构建优化问题**:
    *   **预测模型**: 使用一个（通常是简化的）内部模型，预测在给定的**控制序列**下，系统状态在未来 `H_p` 时间内的演化。
    *   **目标函数**: 定义一个在 `H_p` 时间内需要被最小化的目标，例如 `cost = (水位与目标水位的偏差)^2 + (控制动作的变化率)^2 + (超限惩罚)`。
    *   **约束条件**: 定义系统的物理或操作约束，如水位的最大最小值、闸门开度的变化速率等。
4.  **求解优化问题**: 使用数值优化器（代码中为 `scipy.optimize.minimize`）求解该问题，得到一个在未来 `H_p` 内最优的**控制序列**（例如，未来24小时每个小时的闸门开度设定点）。
5.  **应用第一个控制动作**: **这是MPC的关键**——虽然计算出了整个时域的控制序列，但智能体**只将序列中的第一个控制动作**（即当前时刻的最优动作）发送给本地控制器。
6.  **重复**: 在下一个时间步，系统进入新的状态，智能体重复以上所有步骤，基于新的状态和滚动更新的预测，重新进行优化计算。

这个“滚动优化”的过程使得MPC能够不断地利用最新的反馈信息来修正其决策，从而对不确定性和扰动具有很强的鲁棒性。

## 3. 在 `core_lib` 中的实现

*   `__init__()`: 初始化MPC参数，如预测时域 `horizon`、权重系数 `q_weight` 和 `r_weight`、约束 `flood_thresholds` 等。同时，订阅所需的状态和预测主题。
*   `_objective_function()`: 这是MPC的核心。它接收一个控制序列的“猜测值”，并使用简化的内部模型来预测未来的系统状态，最终返回该控制序列对应的总成本(cost)。优化器的目标就是找到使这个函数返回值最小的控制序列。
*   `run()`:
    *   从 `self.latest_states` 和 `self.latest_forecast` 中获取最新的信息。
    *   调用 `scipy.optimize.minimize` 来运行优化。
    *   如果优化成功，提取出最优控制序列中的第一个值。
    *   将这个值作为新的设定点，发布到消息总线上，供 `LocalControlAgent` 使用。

## 4. 适用场景

MPC适用于具有以下特点的复杂系统：
*   系统具有较大的惯性和延迟（如大型水库、长距离输水渠）。
*   需要考虑未来的扰动（如洪水预报）。
*   存在多个相互冲突的优化目标（如防洪安全 vs. 发电效益）。
*   系统有明确的物理或操作约束。
