# 核心智能体: 中央协调智能体

本篇文档介绍一系列用于实现系统级、全局性协调与决策的中央智能体。这些智能体位于控制层级的顶端，负责监控整个系统的状态并下发宏观指令。

---

## 1. `CentralPerceptionAgent` (中央感知智能体)

*   **源代码**: `core_lib/central_coordination/perception/central_perception_agent.py`

### 概述

`CentralPerceptionAgent` 扮演着多智能体系统（MAS）的“感觉中枢”或“态势中心”的角色。它的核心职责是**汇集**信息，而不是产生信息。

### 工作机制

1.  **订阅多个主题**: 在初始化时，该智能体需要配置一个包含多个“组件ID”到“状态主题”映射的字典。它会订阅所有这些由底层的、分布式的感知智能体（如 `ReservoirPerceptionAgent`, `PumpStationPerceptionAgent` 等）发布的状态主题。
2.  **构建全局状态**: 当任何一个被订阅的主题上有新的状态消息到达时，`CentralPerceptionAgent` 会用该消息更新其内部维护的一个“全局状态”字典。这个字典以组件ID为键，保存了每个组件的最新状态。
3.  **发布全局状态**: 在 `run()` 方法被调用时（即每个仿真步长），它会将这个包含了所有组件最新状态的、完整的全局状态字典，发布到一个统一的“全局状态主题” (`global_state_topic`) 上。

这个智能体为系统中的其他中央决策者（如调度员、优化算法或数字孪生可视化平台）提供了一个单一、全面的数据来源。

---

## 2. `CentralDispatcherAgent` (统一中央调度智能体)

*   **源代码**: `core_lib/central_coordination/dispatch/central_dispatcher.py`

### 概述

`CentralDispatcherAgent` 是一个统一的、多功能的中央调度智能体，旨在根据不同的系统需求和运行模式，提供灵活的顶层决策支持。通过在配置文件中设置 `mode` 参数，该智能体可以工作在以下三种不同的模式之一。

### 配置

在 `agents.yml` 文件中，通过 `config` 块下的 `mode` 字段来指定其行为：

```yaml
- id: my_central_dispatcher
  class: CentralDispatcherAgent
  config:
    mode: "rule" # "rule", "emergency", or "mpc"
    # ... 其他特定于模式的参数 ...
```

### 工作模式

#### 模式 A: `mode: "emergency"` (应急响应调度)

*   **目的**: 作为高优先级、以安全为核心的应急响应智能体。
*   **工作机制**:
    *   **直接访问物理模型**: 初始化时需要直接传入一个关键物理对象（如一个重要的水库 `Reservoir`）的实例。
    *   **紧急状态检查**: 在 `run()` 方法中，它会直接调用物理对象的 `get_state()` 方法来检查关键指标（如水位）。
    *   **发布覆盖指令**: 如果发现指标超过了预设的紧急阈值（如 `emergency_flood_level`），它会立即向执行器（如一个下游的供水闸门）的动作主题发布一个**强制性**的控制指令（如“立刻关闭闸门”），这个指令会覆盖掉由常规控制智能体发出的指令。

#### 模式 B: `mode: "rule"` (规则化 supervisory 控制)

*   **目的**: 作为基于规则的、 supervisory 级别的控制器，通过调整远程控制器的设定点（Setpoint）来实现对系统某个宏观指标的间接管理。
*   **工作机制**:
    *   **订阅观测值**: 订阅一个它关心的状态主题（如某个末端水库的水位），从中获取当前的观测值。
    *   **应用规则**: 其核心逻辑是一种简单的**滞回控制**（或称“bang-bang”控制）。在配置中定义高、低两个水位阈值，以及分别对应的两种控制策略（高、低两种设定点）。
        *   如果当前水位低于 `low_level`，它会向远程控制器发布 `high_setpoint`。
        *   如果当前水位高于 `high_level`，它会向远程控制器发布 `low_setpoint`。
    *   **发布设定点**: 它将计算出的新设定点 `new_setpoint` 发布到一个 `command_topic` 上。

#### 模式 C: `mode: "mpc"` (模型预测控制)

*   **目的**: 采用模型预测控制 (MPC) 算法进行全局优化调度，实现对系统的**前瞻性、最优化**调度。
*   **工作机制**:
    *   **订阅状态和预测**: 订阅多个系统状态（如上下游水位）和外部扰动预测（如未来入库流量）。
    *   **滚动优化**: 在每个控制周期，它会：
        1.  获取当前系统状态作为优化的初始条件。
        2.  使用内部的简化系统模型，在未来一个有限的时间域（`prediction_horizon`）内进行仿真。
        3.  通过 `scipy.optimize.minimize` 求解一个目标函数，该函数旨在最小化控制目标（如设定点）与理想值的偏差、控制动作的变化量以及超出安全阈值的惩罚。
    *   **发布优化指令**: 优化求解器会得出一系列最优的控制动作（如未来几个小时的设定点），智能体会将此序列中的第一个动作发布给下层的本地控制器。
*   **核心优势**: 相比于基于当前状态的反应式控制，MPC能够“预见”未来的变化并提前做出最优应对，从而实现更平滑、更高效、更安全的系统运行。
