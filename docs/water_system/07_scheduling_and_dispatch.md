# 7. 调度与分发 (Scheduling & Dispatch)

本篇文档详细介绍 `core_lib` 中用于高层级协调和优化调度的功能。`core_lib` 提供两种不同复杂度的核心智能体来实现这一目标：一种基于规则，一种基于优化。

## 1. 核心理念：分层的、基于设定点的控制

与直接计算每个设备未来24小时完整操作序列的传统调度不同，本系统采用了一种更具动态适应性的**分层控制**思想。

*   **高层 (调度层)**: 中心化的调度智能体（如 `CentralDispatcher` 或 `CentralMPCAgent`）不直接控制设备。相反，它们根据全局信息和预测，计算出**下一时刻的最优工作状态**，即**设定点 (Setpoint)**（例如，下游某断面的目标水位应为55.0米）。
*   **低层 (控制层)**: 它们将这个设定点作为指令，通过消息总线发送给相应的**本地控制智能体** (详见“控制”章节)。
*   **执行**: 本地控制智能体（如一个 `PIDController`）接收到新的设定点后，负责通过高频次的、具体的控制动作（如微调闸门开度）来使被控变量（实际水位）达到并维持在这个新的设定点上。

这种分层架构将“长期优化”和“实时控制”两个不同时间尺度的问题解耦，使系统兼具了宏观上的最优性和微观上的鲁棒性。

## 2. 基于规则的分发器: `CentralDispatcher`

*   **位置**: `core_lib/central_coordination/dispatch/central_dispatcher.py`
*   **方法**: **基于规则 (Rule-Based)**
*   **工作流程**:
    1.  **订阅**: 监听关键的系统状态和预测信息。
    2.  **匹配**: 在每个时间步，将当前的系统状态与预定义的“**场景 (Profiles)**”列表进行匹配。每个场景都有一个触发条件。
    3.  **激活**: 一旦某个场景的条件被满足（例如，`if reservoir_level > emergency_threshold`），该场景就被激活。
    4.  **发布指令**: 调度器将该场景下预设好的一组指令（例如，`{"new_setpoint": 54.0}`）发布到对应的本地控制器命令主题上。
*   **适用场景**: 适用于具有明确、固定的操作规程的场景，如应急预案、固定的季节性运行图等。它响应快速、行为可预测，但缺乏对未知情况的自适应优化能力。

## 3. 基于优化的调度器: `CentralMPCAgent`

*   **位置**: `core_lib/central_coordination/dispatch/central_mpc_agent.py`
*   **方法**: **模型预测控制 (Model Predictive Control, MPC)**
*   **工作流程**:
    1.  **订阅**: 监听系统状态和**未来一段时间**的扰动预测（如未来24小时的入流洪水过程）。
    2.  **构建优化问题**: 在每个时间步，它基于一个**简化的内部预测模型**、**目标函数** (`_objective_function`) 和一系列**约束**，构建一个数学优化问题。
        *   **目标函数**通常包含多个部分：惩罚与目标设定点的偏差、惩罚控制动作的剧烈变化、惩罚超限（如洪水）等。
        *   **决策变量**是未来N个时间步的控制设定点序列。
    3.  **求解**: 调用一个数值优化器（如 `scipy.optimize.minimize`）来求解这个优化问题，得到未来N步的最优设定点序列。
    4.  **发布指令**: **只将计算出的最优序列中的第一个设定点**发布给本地控制器。在下一个时间步，它会基于新的系统状态，重复整个过程（即“滚动优化”）。
*   **适用场景**: 适用于需要动态、前瞻性优化的复杂场景。它能够综合考虑未来的影响，找到当前最优的控制决策，但对模型的准确性和计算资源有更高要求。
