# 物理模型: 渠池 (Canal)

本篇文档介绍两种用于模拟明渠或渠池水力学行为的物理模型：`Canal` 和 `IntegralDelayCanal`。

## 1. `Canal` (曼宁方程渠池)

*   **源代码**: `core_lib/physical_objects/canal.py`
*   **核心方程**: 曼宁方程 (Manning's Equation)

### 概述

`Canal` 模型代表了一段具有梯形横截面的明渠。它使用曼宁方程来计算水流，这是一个广泛应用于水利工程领域的经验公式，能够很好地模拟重力驱动下的稳定、均匀流动。

该模型主要用于需要较为精确地模拟渠池内水位、蓄水量和出流量之间关系的场景。

### 状态变量 (State)

-   `volume` (float): 渠池当前的总蓄水量 (m³)。
-   `water_level` (float): 根据当前蓄水量反算出的水深 (m)。
-   `outflow` (float): 在当前状态下，通过曼宁方程计算出的渠池出流量 (m³/s)。

### 参数 (Parameters)

-   `bottom_width` (float): 渠池底部的宽度 (m)。
-   `length` (float): 渠池的长度 (m)。
-   `slope` (float): 渠底的纵向坡度 (无量纲)。
-   `side_slope_z` (float): 边坡的坡度系数 (z:1, 水平:垂直)。例如，`z=2` 表示边坡每升高1米，水平方向延伸2米。
-   `manning_n` (float): 曼宁糙率系数，反映了渠壁的粗糙程度。

### 工作机制

1.  **输入**: 在每个 `step` 中，`Canal` 接收上游连接组件传递的物理入流 (`_inflow`)。此外，它还可以选择性地订阅一个 `inflow_topic`，以接收来自消息总线的数据驱动入流（如降雨预报产生的径流），总入流量为两者之和。
2.  **状态更新**:
    -   模型首先根据当前的 `volume` 和渠道的几何形状（梯形），通过求解二次方程来反算出 `water_level`。
    -   然后，基于 `water_level` 计算出当前水流的几何要素（如过水断面面积、湿周）。
    -   最后，将这些要素代入曼宁方程，计算出 `outflow`。
3.  **质量平衡**: 模型的 `volume` 根据总入流量和计算出的出流量进行更新 (`volume += (inflow - outflow) * dt`)，确保水量守恒。

---

## 2. `IntegralDelayCanal` (积分延迟渠池)

*   **源代码**: `core_lib/physical_objects/integral_delay_canal.py`
*   **核心方程**: 积分加时间延迟模型

### 概述

`IntegralDelayCanal` 是一个简化的概念模型，常用于控制系统设计和分析。它不关注详细的水力学过程，而是抓住了长距离输水渠道的两个最核心的动态特性：

1.  **蓄能效应 (Integration)**: 渠池像一个积分器，入流会不断累积，导致水位持续上升或下降。
2.  **时滞效应 (Time Delay)**: 由于水波传播需要时间，上游的入流变化需要一段时间 (`tau`) 才能体现在下游。

该模型非常适合用于快速搭建控制策略原型和进行稳定性分析的场景。

### 状态变量 (State)

-   `water_level` (float): 渠池**下游末端**的水位 (m)。
-   `outflow` (float): 渠池的出流量，模型中被简化为**延迟后的入流量** (m³/s)。

### 参数 (Parameters)

-   `gain` (float): 过程的积分增益 (K)。它通常与渠池的表面积成反比 (`K = 1 / A_surface`)。
-   `delay` (float): 从上游到下游的水流时间延迟 (s)。

### 工作机制

1.  **历史缓冲区**: 模型内部维护一个先进先出（FIFO）的队列 `inflow_history`，用于存储过去一段时间的入流量。队列的长度根据 `delay` 和时间步长 `dt` 决定。
2.  **延迟入流**: 在每个 `step` 中，模型从历史缓冲区的最前端取出最旧的入流量数据，这个数据即为 `t - delay` 时刻的延迟入流。
3.  **水位更新**: 模型使用离散化的积分公式 `water_level += gain * delayed_inflow * dt` 来更新下游水位。
4.  **出流**: 模型的出流量被直接定义为 `delayed_inflow`。

### 模型对比

| 特性 | `Canal` | `IntegralDelayCanal` |
| :--- | :--- | :--- |
| **复杂度** | 高，基于物理方程 | 低，概念化模型 |
| **准确性** | 较高，反映真实水力学 | 较低，仅捕捉核心动态 |
| **计算成本** | 较高 | 极低 |
| **适用场景** | 精细化仿真、水力分析 | 控制器设计、系统辨识、快速原型 |
